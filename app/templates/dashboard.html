{% extends "base.html" %}

{% block title %}Dashboard - Smart Study Planner{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">
  <!-- Side Menu -->
  <div class="lg:w-1/4">
    <div class="bg-white rounded-xl shadow-md p-6 sticky top-4">
      <h2 class="text-xl font-bold mb-6 text-gray-800">Study Overview</h2>
      
      <!-- Navigation -->
      <nav class="space-y-2">
        <a href="{{ url_for('main.dashboard') }}" class="block px-4 py-2 rounded-lg bg-blue-50 text-blue-600 font-medium">
          <i class="fas fa-chart-pie mr-2"></i> Overview
        </a>
        <a href="{{ url_for('main.ai_dashboard') }}" class="block px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-700">
          <i class="fas fa-robot mr-2"></i> AI Tasks
        </a>
        <a href="{{ url_for('main.personal_tasks') }}" class="block px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-700">
          <i class="fas fa-tasks mr-2"></i> My Tasks
        </a>
        <a href="{{ url_for('main.plan') }}" class="block px-4 py-2 rounded-lg hover:bg-gray-100 text-gray-700">
          <i class="fas fa-calendar-plus mr-2"></i> Create Plan
        </a>
      </nav>
      
      <!-- Quick Stats -->
      <div class="mt-8 pt-6 border-t border-gray-200">
        <h3 class="font-medium text-gray-700 mb-3">Quick Stats</h3>
        <div class="space-y-4">
          <div>
            <p class="text-sm text-gray-500">Total Tasks</p>
            <p class="text-2xl font-bold">{{ stats.total_tasks }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Completed</p>
            <p class="text-2xl font-bold">{{ stats.completed_ai_tasks + stats.completed_personal_tasks }}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Upcoming</p>
            <p class="text-2xl font-bold">{{ stats.total_ai_tasks + stats.total_personal_tasks - (stats.completed_ai_tasks + stats.completed_personal_tasks) }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content - Overview Only -->
  <div class="lg:w-3/4">
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
          {% if study_plan %}
            {{ study_plan.name }} Overview
          {% else %}
            Study Overview
          {% endif %}
        </h2>
        <span class="text-sm text-gray-500">Last updated: {{ stats.last_updated.strftime('%b %d, %Y') }}</span>
      </div>
      
      <!-- Progress Charts -->
      <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="bg-blue-50 p-4 rounded-lg">
          <h3 class="font-medium mb-2">Completion Progress</h3>
          <div class="h-40 flex items-center justify-center">
            <div class="text-4xl font-bold text-blue-600">
              {{ stats.completion_rate }}%
            </div>
          </div>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <h3 class="font-medium mb-2">Time Distribution</h3>
          <div class="h-40 flex items-center justify-center">
            <div id="timeChart" class="w-full h-full"></div>
          </div>
        </div>
      </div>
      
      <!-- Subject Progress -->
      {% if study_plan and study_plan.subjects %}
      <div class="mb-8">
        <h3 class="font-medium mb-3">Subject Progress</h3>
        <div class="space-y-3">
          {% for subject in study_plan.subjects %}
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-medium">{{ subject.name }}</span>
              <span class="text-sm">
                {% set subject_tasks = [] %}
                {% for task in all_tasks %}
                  {% if task.title.startswith(subject.name) %}
                    {% set _ = subject_tasks.append(task) %}
                  {% endif %}
                {% endfor %}
                {{ subject_tasks|selectattr('is_done')|list|length }}/{{ subject_tasks|length }}
              </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="bg-blue-600 h-2.5 rounded-full min-w-[2px]" 
                   style="width: {{ (subject_tasks|selectattr('is_done')|list|length / subject_tasks|length * 100) if subject_tasks|length > 0 else 0 }}%">
              </div>
            </div>
          </div>
          {% endfor %}
        </div>  
      </div>
      {% endif %}
      
      <!-- Upcoming Deadlines -->
      <div>
        <h3 class="font-medium mb-3">Upcoming Deadlines</h3>
        {% if upcoming_deadlines %}
        <div class="space-y-2">
          {% for deadline in upcoming_deadlines %}
          <div class="p-3 border rounded-lg {% if deadline.days_left <= 3 %}bg-red-50 border-red-200{% else %}bg-white{% endif %}">
            <div class="flex justify-between items-center">
              <div>
                <h4 class="font-medium">{{ deadline.subject.name }}</h4>
                <p class="text-sm text-gray-600">
                  Exam: {{ deadline.subject.exam_date.strftime('%b %d, %Y') }}
                </p>
              </div>
              <span class="text-sm {% if deadline.days_left <= 3 %}text-red-600 font-medium{% else %}text-gray-500{% endif %}">
                {% if deadline.days_left == 0 %}
                  Today
                {% else %}
                  {{ deadline.days_left }} day{{ 's' if deadline.days_left > 1 }} left
                {% endif %}
              </span>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="p-4 bg-gray-50 rounded-lg text-center">
          <i class="fas fa-calendar-check text-gray-300 text-2xl mb-2"></i>
          <p class="text-gray-500">No upcoming deadlines found</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const timeChartEl = document.getElementById('timeChart');
  
  // Show loading state
  if (timeChartEl) {
    timeChartEl.innerHTML = `
      <div class="chart-fallback">
        <i class="fas fa-spinner fa-spin text-blue-500 text-2xl mb-2"></i>
        <p class="text-gray-500">Loading chart...</p>
      </div>
    `;
    
    try {
      // Get data from template
      const subjectNames = JSON.parse('{{ subjects|map(attribute="name")|list|tojson|safe }}');
      const subjectHours = JSON.parse('{{ subject_hours|tojson|safe }}');
      
      // Filter valid data
      const validData = subjectNames.map((name, i) => ({
        name: name,
        hours: subjectHours[i] || 0
      })).filter(item => item.hours > 0);
      
      if (validData.length > 0) {
        new Chart(timeChartEl, {
          type: 'doughnut',
          data: {
            labels: validData.map(item => item.name),
            datasets: [{
              data: validData.map(item => item.hours),
              backgroundColor: [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#ec4899', '#14b8a6', '#f97316', '#64748b', '#a855f7'
              ],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  boxWidth: 12,
                  padding: 20
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.label}: ${context.raw} hrs`;
                  }
                }
              }
            }
          }
        });
      } else {
        timeChartEl.innerHTML = `
          <div class="chart-fallback">
            <i class="fas fa-chart-pie text-gray-300 text-4xl mb-2"></i>
            <p class="text-gray-500">No data available</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('Chart error:', error);
      timeChartEl.innerHTML = `
        <div class="chart-fallback">
          <i class="fas fa-exclamation-triangle text-red-300 text-4xl mb-2"></i>
          <p class="text-red-500">Error loading chart</p>
        </div>
      `;
    }
  }
});
</script>

<style>
  .chart-fallback {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
  }
</style>
{% endblock %}