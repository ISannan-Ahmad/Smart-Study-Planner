{% extends "base.html" %}

{% block title %}AI Tasks Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold">AI-Generated Tasks</h1>
    <div class="flex items-center space-x-4">
      <div class="relative">
        <select id="planFilter" class="appearance-none bg-white border border-gray-300 rounded-md px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Plans</option>
          {% for plan in study_plans %}
          <option value="{{ plan.id }}" {% if current_filter == plan.id|string %}selected{% endif %}>{{ plan.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Stats Cards -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-sm font-medium text-gray-500">Total AI Tasks</h3>
      <p id="totalTasks" class="text-3xl font-bold mt-2">{{ stats.total_ai_tasks }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-sm font-medium text-gray-500">Completed</h3>
      <p id="completedTasks" class="text-3xl font-bold mt-2">{{ stats.completed_ai_tasks }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-sm font-medium text-gray-500">Completion Rate</h3>
      <p id="completionRate" class="text-3xl font-bold mt-2">
        {{ (stats.completed_ai_tasks / stats.total_ai_tasks * 100) if stats.total_ai_tasks > 0 else 0 | round(1) }}%
      </p>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="divide-y divide-gray-200" id="tasksContainer">
      {% for task in ai_tasks %}
      <div class="task-item p-4 hover:bg-gray-50 {% if task.is_done %}bg-green-50{% endif %}" 
           data-plan-id="{{ task.plan_id }}">
        <div class="flex items-start">
          <form method="POST" action="{{ url_for('main.complete_task', task_id=task.id) }}" class="mr-3">
            <input type="hidden" name="current_plan_filter" value="{{ current_filter }}">
            <button type="submit" class="p-1.5 rounded-full {% if task.is_done %}bg-green-100 text-green-600{% else %}bg-gray-100 text-gray-400 hover:bg-green-50 hover:text-green-500{% endif %}">
              <i class="fas {% if task.is_done %}fa-check-circle{% else %}fa-circle{% endif %}"></i>
            </button>
          </form>
          <div class="flex-grow">
            <div class="flex justify-between">
              <h3 class="font-medium {% if task.is_done %}line-through text-gray-600{% endif %}">
                {{ task.title }}
                <span class="text-xs ml-2 text-gray-500 hidden plan-name-display">
                  ({{ task.plan.name }})
                </span>
              </h3>
              <span class="text-xs px-2 py-1 rounded-full 
                {% if task.priority == 1 %}bg-red-100 text-red-800
                {% elif task.priority == 2 %}bg-yellow-100 text-yellow-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {% if task.priority == 1 %}High
                {% elif task.priority == 2 %}Medium
                {% else %}Low{% endif %} priority
              </span>
            </div>
            <p class="text-sm text-gray-600 mt-1 {% if task.is_done %}opacity-75{% endif %}">
              {{ task.description }}
            </p>
            <div class="flex items-center mt-2 text-xs text-gray-500">
              <i class="far fa-calendar-alt mr-1.5"></i>
              <span>{{ task.scheduled_date.strftime('%b %d, %Y') }}</span>
              <span class="mx-2">â€¢</span>
              <i class="fas fa-clock mr-1.5"></i>
              <span>{{ task.duration_minutes }} minutes</span>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const planFilter = document.getElementById('planFilter');
  const taskItems = document.querySelectorAll('.task-item');
  
  // Store original stats
  const statsData = document.getElementById('statsData');
  const originalStats = {
    total: parseInt(statsData.dataset.total),
    completed: parseInt(statsData.dataset.completed),
    rate: parseFloat(statsData.dataset.rate)
  };

  // Show plan names when filtered
  function showPlanNames(show) {
    document.querySelectorAll('.plan-name-display').forEach(el => {
      el.classList.toggle('hidden', !show);
    });
  }

  // Update stats display
  function updateStats(total, completed) {
    document.getElementById('totalTasks').textContent = total;
    document.getElementById('completedTasks').textContent = completed;
    const rate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;
    document.getElementById('completionRate').textContent = `${rate}%`;
  }

  planFilter.addEventListener('change', function() {
    const selectedPlanId = this.value;
    let visibleCount = 0;
    let completedCount = 0;

    taskItems.forEach(item => {
      const matchesFilter = selectedPlanId === 'all' || item.dataset.planId === selectedPlanId;
      
      if (matchesFilter) {
        item.style.display = 'block';
        visibleCount++;
        if (item.classList.contains('bg-green-50')) {
          completedCount++;
        }
      } else {
        item.style.display = 'none';
      }
    });

    // Update stats
    if (selectedPlanId === 'all') {
      updateStats(originalStats.total, originalStats.completed);
    } else {
      updateStats(visibleCount, completedCount);
    }

    // Show plan names only when filtered
    showPlanNames(selectedPlanId !== 'all');
    
    // Update hidden inputs in forms
    document.querySelectorAll('input[name="current_plan_filter"]').forEach(input => {
      input.value = selectedPlanId;
    });
  });
  
  // Initialize
  showPlanNames(planFilter.value !== 'all');
});
</script>

<style>
.task-item {
  transition: opacity 0.3s ease;
}
.hidden {
  display: none;
}
.plan-name-display {
  display: inline;
}
</style>

<!-- Hidden element for storing original stats -->
<div id="statsData" 
     data-total="{{ stats.total_ai_tasks }}"
     data-completed="{{ stats.completed_ai_tasks }}"
     data-rate="{{ (stats.completed_ai_tasks / stats.total_ai_tasks * 100) if stats.total_ai_tasks > 0 else 0 | round(1) }}"
     style="display:none;"></div>
{% endblock %}